<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iRacing Personal Records Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050510;
      --bg-elevated: #111323;
      --bg-elevated-soft: #181a2e;
      --accent: #4c6fff;
      --accent-soft: rgba(76,111,255,0.12);
      --accent-strong: #ffbf3c;
      --text: #f5f5f7;
      --text-soft: #b4b7c8;
      --danger: #ff4c4c;
      --success: #1ecb70;
      --border-subtle: #24263a;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-soft: 0 14px 45px rgba(0,0,0,0.6);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text","Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #151731 0, #02030b 48%, #020109 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app { width: 100%; max-width: 1220px; }

    header { margin-bottom: 12px; }

    .badge {
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.05);
      font-size:11px;text-transform:uppercase;letter-spacing:0.08em;
      color:var(--text-soft);
    }

    .badge-dot {
      width:6px;height:6px;border-radius:50%;
      background:var(--accent);box-shadow:0 0 8px rgba(76,111,255,0.9);
    }

    h1 {
      font-size:28px;margin:10px 0 4px;
      display:flex;align-items:center;gap:10px;
    }

    h1 span.logo-pill {
      display:inline-flex;align-items:center;justify-content:center;
      width:26px;height:26px;border-radius:9px;
      background:linear-gradient(135deg,#ff4b91,#ffbf3c);
      font-size:15px;
    }

    header p { margin:0;color:var(--text-soft);font-size:14px; }

    /* NAV TABS */
    .nav-tabs {
      display:flex;
      gap:6px;
      margin-bottom:14px;
      border-radius:999px;
      padding:3px;
      background:rgba(7,8,20,0.9);
      border:1px solid rgba(255,255,255,0.06);
    }

    .nav-tab {
      flex:1 1 0;
      border:none;
      border-radius:999px;
      padding:6px 10px;
      font-size:13px;
      cursor:pointer;
      background:transparent;
      color:var(--text-soft);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:background 0.15s ease,color 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease;
    }

    .nav-tab span.icon {
      font-size:14px;
    }

    .nav-tab-active {
      background:var(--accent);
      color:#fff;
      box-shadow:0 12px 28px rgba(76,111,255,0.6);
      transform:translateY(-1px);
    }

    .nav-tab-active span.sub {
      opacity:0.95;
    }

    .nav-tab span.sub {
      font-size:11px;
      opacity:0.7;
    }

    /* LAYOUT GENERAL */
    .layout {
      display:grid;
      grid-template-columns:minmax(0, 340px) minmax(0, 1fr);
      gap:18px;
    }

    .panel {
      background:radial-gradient(circle at 0 0,#252a4d 0,#111323 32%,#080918 100%);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(255,255,255,0.04);
      padding:16px 16px 14px;
      position:relative;
      overflow:hidden;
    }

    .panel::before {
      content:"";position:absolute;inset:0;pointer-events:none;opacity:0.5;
      background:radial-gradient(circle at top left,rgba(76,111,255,0.16),transparent 55%);
    }

    .panel > * { position:relative;z-index:1; }

    .panel-header {
      display:flex;justify-content:space-between;align-items:baseline;
      margin-bottom:12px;
    }

    .panel-header h2 { margin:0;font-size:16px; }
    .panel-header span.sub { font-size:12px;color:var(--text-soft); }

    /* FORM */
    form label {
      display:block;font-size:12px;margin-bottom:4px;color:var(--text-soft);
    }

    .form-grid {
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px 12px;
    }

    .form-row-full { grid-column:1 / -1; }

    input[type="text"],input[type="number"],input[type="date"],select,textarea {
      width:100%;
      padding:7px 9px;
      border-radius:var(--radius-sm);
      border:1px solid var(--border-subtle);
      background:#050613;
      color:var(--text);
      font-size:13px;
      outline:none;
      transition:border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input[type="text"]:focus,input[type="number"]:focus,input[type="date"]:focus,select:focus,textarea:focus {
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(76,111,255,0.5);
      background:#06071a;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance:none;margin:0; }
    input[type="number"] { -moz-appearance:textfield; }

    textarea { min-height:52px;resize:vertical; }

    .hint { font-size:11px;color:var(--text-soft);margin-top:2px; }

    .pill-row {
      display:flex;flex-wrap:wrap;gap:6px;
      margin:6px 0 10px;
    }

    .pill-row .pill {
      padding:3px 8px;border-radius:999px;font-size:11px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.02);color:var(--text-soft);
    }

    .btn-row {
      display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap;
    }

    button {
      border:none;border-radius:999px;
      padding:7px 13px;font-size:13px;cursor:pointer;
      display:inline-flex;align-items:center;gap:6px;
      background:var(--accent);color:white;
      box-shadow:0 10px 25px rgba(76,111,255,0.55);
      transition:transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
      white-space:nowrap;
    }

    button:hover {
      transform:translateY(-1px);
      box-shadow:0 13px 32px rgba(76,111,255,0.68);
      background:#5c7cff;
    }

    button.secondary {
      background:rgba(255,255,255,0.02);
      color:var(--text-soft);
      box-shadow:none;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.05);
      padding-inline:11px;
      font-size:12px;
    }

    button.secondary:hover {
      background:rgba(255,255,255,0.04);
      border-color:rgba(255,255,255,0.13);
    }

    .btn-ghost-danger {
      background:rgba(255,76,76,0.06);
      color:#ff8a8a;
      box-shadow:none;
      border-radius:999px;
      border:1px solid rgba(255,76,76,0.3);
      padding-inline:11px;
      font-size:12px;
    }

    .btn-ghost-danger:hover { background:rgba(255,76,76,0.12); }

    .small-label { font-size:11px;color:var(--text-soft); }

    /* Stats */
    .stats-row {
      display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;
    }

    .stat-card {
      flex:1 1 0;min-width:90px;
      background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(76,111,255,0.25));
      border-radius:var(--radius-md);
      padding:8px 10px;
      border:1px solid rgba(255,255,255,0.05);
    }

    .stat-label { font-size:11px;color:var(--text-soft);margin-bottom:2px; }
    .stat-value { font-size:17px;font-weight:600; }
    .stat-pill { font-size:11px;margin-top:2px;color:var(--text-soft); }
    .stat-value.positive { color:var(--success); }
    .stat-value.negative { color:var(--danger); }

    /* Filters */
    .filters-row {
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px;
    }

    .filters-row input,.filters-row select {
      font-size:12px;padding:6px 9px;
    }

    .filters-row .grow { flex:1 1 120px; }

    .filters-row label { font-size:11px;margin-bottom:2px; }

    /* Table */
    .table-wrapper {
      border-radius:var(--radius-md);
      border:1px solid rgba(255,255,255,0.04);
      overflow:hidden;
      background:rgba(5,6,19,0.8);
      max-height:520px;
      display:flex;flex-direction:column;
    }

    table { border-collapse:collapse;width:100%;font-size:12px;table-layout:fixed; }

    thead { background:rgba(10,11,30,0.96); }

    th,td {
      padding:6px 8px;
      border-bottom:1px solid rgba(255,255,255,0.04);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    th {
      position:sticky;top:0;z-index:1;
      text-align:left;font-size:11px;
      color:var(--text-soft);font-weight:500;
      cursor:pointer;user-select:none;
    }

    th.sortable::after {
      content:"‚áÖ";font-size:9px;opacity:0.55;margin-left:4px;
    }
    th.sort-asc::after { content:"‚Üë";opacity:0.9; }
    th.sort-desc::after { content:"‚Üì";opacity:0.9; }

    tbody tr:nth-child(even) { background:rgba(255,255,255,0.02); }
    tbody tr:hover { background:rgba(76,111,255,0.12); }

    td span.tag {
      display:inline-flex;align-items:center;
      padding:2px 7px;border-radius:999px;
      background:rgba(255,255,255,0.04);
      font-size:10px;color:var(--text-soft);
    }

    .cell-notes { color:var(--text-soft);font-size:11px; }

    .table-footer {
      padding:6px 10px;font-size:11px;color:var(--text-soft);
      display:flex;justify-content:space-between;align-items:center;
      background:rgba(0,0,0,0.5);
    }

    .empty-state {
      padding:32px 20px;text-align:center;font-size:13px;color:var(--text-soft);
    }

    .empty-state strong { color:var(--accent-strong); }

    /* Export / Import */
    .export-area {
      margin-top:10px;padding-top:8px;
      border-top:1px dashed rgba(255,255,255,0.08);
    }

    .export-row {
      display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;
    }

    .export-row textarea {
      flex:1 1 100%;font-size:11px;
    }

    .export-hint { font-size:11px;color:var(--text-soft); }

    /* Views */
    .view { display:none; }
    .view-active { display:block; }

    /* Lap & Results layout */
    .panel-full {
      grid-column:1 / -1;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns:minmax(0,1fr); }
      .panel-full { grid-column:1 / -1; }
    }

    @media (max-width: 600px) {
      th:nth-child(6),
      td:nth-child(6),
      th:nth-child(7),
      td:nth-child(7),
      th:nth-child(9),
      td:nth-child(9),
      th:nth-child(11),
      td:nth-child(11) {
        display:none;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="badge">
        <span class="badge-dot"></span>
        Personal iRacing Tracker
      </div>
      <h1>
        <span class="logo-pill">üèÅ</span>
        Race Records & Leaderboard Hub
      </h1>
      <p>
        Log your iRacing sessions, track your best laps and results, and flip between views using the tabs.
        All data is stored locally in your browser.
      </p>
    </header>

    <nav class="nav-tabs">
      <button class="nav-tab nav-tab-active" data-view="sessions">
        <span class="icon">üìí</span>
        <span>Sessions</span>
      </button>
      <button class="nav-tab" data-view="laps">
        <span class="icon">‚è±Ô∏è</span>
        <span>Lap Times</span>
      </button>
      <button class="nav-tab" data-view="results">
        <span class="icon">üèÜ</span>
        <span>Results</span>
      </button>
    </nav>

    <!-- VIEW: SESSIONS (original layout) -->
    <section id="view-sessions" class="view view-active">
      <main class="layout">
        <!-- LEFT: FORM PANEL -->
        <section class="panel">
          <div class="panel-header">
            <h2>Add / Edit Session</h2>
            <span class="sub">Keep it simple now, tweak later.</span>
          </div>

          <form id="race-form">
            <input type="hidden" id="race-id" />

            <div class="form-grid">
              <div>
                <label for="date">Date</label>
                <input id="date" type="date" required />
              </div>
              <div>
                <label for="sessionType">Session Type</label>
                <select id="sessionType">
                  <option value="Race">Race</option>
                  <option value="Qualifying">Qualifying</option>
                  <option value="Practice">Practice</option>
                  <option value="Time Trial">Time Trial</option>
                </select>
              </div>

              <div>
                <label for="series">Series</label>
                <input id="series" type="text" placeholder="IMSA, GT3 Fixed, etc." />
              </div>
              <div>
                <label for="car">Car</label>
                <input id="car" type="text" placeholder="BMW M4 GT3, etc." />
              </div>

              <div class="form-row-full">
                <label for="track">Track</label>
                <input id="track" type="text" placeholder="Road Atlanta, Spa, Nordschleife..." />
              </div>

              <div>
                <label for="split">Split</label>
                <input id="split" type="number" min="1" step="1" placeholder="1" />
              </div>
              <div>
                <label for="sof">SOF</label>
                <input id="sof" type="number" min="0" step="1" placeholder="Strength of Field" />
              </div>

              <div>
                <label for="startPos">Start Pos</label>
                <input id="startPos" type="number" min="1" step="1" />
              </div>
              <div>
                <label for="finishPos">Finish Pos</label>
                <input id="finishPos" type="number" min="1" step="1" />
              </div>

              <div>
                <label for="laps">Laps</label>
                <input id="laps" type="number" min="0" step="1" />
              </div>
              <div>
                <label for="bestLap">Best Lap</label>
                <input id="bestLap" type="text" placeholder="e.g. 1:35.432" />
                <div class="hint">Format: m:ss.sss or ss.sss</div>
              </div>

              <div class="form-row-full">
                <label for="iratingChange">iRating Change</label>
                <input id="iratingChange" type="number" step="1" placeholder="+/- value (optional)" />
              </div>

              <div class="form-row-full">
                <label for="notes">Notes</label>
                <textarea id="notes" placeholder="Incidents, strategy notes, setup, etc."></textarea>
              </div>
            </div>

            <div class="pill-row">
              <span class="pill">Tip: Use this like your own private notebook.</span>
              <span class="pill">Export/import data below if you switch devices.</span>
            </div>

            <div class="btn-row">
              <button type="submit" id="save-btn">
                üíæ <span id="save-btn-label">Add Session</span>
              </button>
              <button type="button" class="secondary" id="reset-form-btn">
                Reset Form
              </button>
              <button type="button" class="btn-ghost-danger" id="clear-all-btn">
                Clear All Data
              </button>
            </div>
          </form>

          <div class="export-area">
            <div class="small-label">Export / Import</div>
            <p class="export-hint">
              Use this to backup your data or move it to another device. Click
              <strong>Export</strong>, copy the JSON somewhere safe, and later you can paste it back and hit
              <strong>Import</strong>.
            </p>
            <div class="export-row">
              <textarea id="export-json" placeholder="Exported JSON will appear here..."></textarea>
              <div class="btn-row">
                <button type="button" class="secondary" id="export-btn">Export</button>
                <button type="button" class="secondary" id="import-btn">Import</button>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: TABLE PANEL -->
        <section class="panel">
          <div class="panel-header">
            <h2>Sessions & Leaderboard View</h2>
            <span class="sub"><span id="session-count">0</span> saved</span>
          </div>

          <div class="stats-row">
            <div class="stat-card">
              <div class="stat-label">Total Races</div>
              <div class="stat-value" id="stat-total-races">0</div>
              <div class="stat-pill" id="stat-total-sessions">0 total sessions</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Wins</div>
              <div class="stat-value positive" id="stat-wins">0</div>
              <div class="stat-pill" id="stat-podiums">0 podiums</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Best Lap (All Time)</div>
              <div class="stat-value" id="stat-best-lap">‚Äì</div>
              <div class="stat-pill" id="stat-best-lap-track">No laps logged yet</div>
            </div>
          </div>

          <div class="filters-row">
            <div class="grow">
              <label>Search</label>
              <input id="filter-search" type="text" placeholder="Search track, car, series..." />
            </div>
            <div>
              <label>Session Type</label>
              <select id="filter-session">
                <option value="">All</option>
                <option value="Race">Race</option>
                <option value="Qualifying">Qualifying</option>
                <option value="Practice">Practice</option>
                <option value="Time Trial">Time Trial</option>
              </select>
            </div>
            <div>
              <label>Sort By</label>
              <select id="filter-sort-preset">
                <option value="date-desc">Newest First</option>
                <option value="date-asc">Oldest First</option>
                <option value="bestLap-asc">Best Lap (Fastest)</option>
                <option value="finishPos-asc">Best Result</option>
                <option value="iratingChange-desc">iRating Gain</option>
              </select>
            </div>
          </div>

          <div class="table-wrapper" id="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th class="sortable" data-sort="date">Date</th>
                  <th class="sortable" data-sort="sessionType">Type</th>
                  <th class="sortable" data-sort="series">Series</th>
                  <th class="sortable" data-sort="car">Car</th>
                  <th class="sortable" data-sort="track">Track</th>
                  <th class="sortable" data-sort="split">Split</th>
                  <th class="sortable" data-sort="sof">SOF</th>
                  <th class="sortable" data-sort="startPos">Start</th>
                  <th class="sortable" data-sort="finishPos">Finish</th>
                  <th class="sortable" data-sort="bestLap">Best Lap</th>
                  <th class="sortable" data-sort="iratingChange">iR Œî</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="race-tbody"></tbody>
            </table>
            <div class="empty-state" id="empty-state">
              <strong>No sessions yet.</strong><br />
              Start by logging your next race on the left. This will become your personal
              iRacing ‚Äúleaderboard‚Äù over time.
            </div>
            <div class="table-footer">
              <span id="table-footer-label">0 sessions visible</span>
              <span id="table-footer-tip">Tip: Click column headers to sort.</span>
            </div>
          </div>
        </section>
      </main>
    </section>

    <!-- VIEW: LAP TIMES -->
    <section id="view-laps" class="view">
      <main class="layout">
        <section class="panel panel-full">
          <div class="panel-header">
            <h2>Lap Times View</h2>
            <span class="sub">Filter by track and car, see all best laps.</span>
          </div>

          <div class="filters-row">
            <div>
              <label for="lap-filter-track">Track</label>
              <select id="lap-filter-track">
                <option value="">All tracks</option>
              </select>
            </div>
            <div>
              <label for="lap-filter-car">Car</label>
              <select id="lap-filter-car">
                <option value="">All cars</option>
              </select>
            </div>
            <div class="grow">
              <label for="lap-filter-search">Search</label>
              <input id="lap-filter-search" type="text" placeholder="Search series / notes..." />
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Track</th>
                  <th>Car</th>
                  <th>Session</th>
                  <th>Best Lap</th>
                  <th>Series</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="lap-tbody"></tbody>
            </table>
            <div class="empty-state" id="lap-empty">
              <strong>No lap times yet.</strong><br />
              Any session with a best lap will show up here.
            </div>
            <div class="table-footer">
              <span id="lap-footer-label">0 laps visible</span>
              <span>Tip: filter by track and car to compare pace.</span>
            </div>
          </div>
        </section>
      </main>
    </section>

    <!-- VIEW: RESULTS -->
    <section id="view-results" class="view">
      <main class="layout">
        <section class="panel panel-full">
          <div class="panel-header">
            <h2>Race Results</h2>
            <span class="sub">Wins, podiums, and race-only stats.</span>
          </div>

          <div class="filters-row">
            <div>
              <label for="res-filter-only-wins">
                <input type="checkbox" id="res-filter-only-wins" />
                Wins only
              </label>
            </div>
            <div>
              <label for="res-filter-only-podiums">
                <input type="checkbox" id="res-filter-only-podiums" />
                Podiums only
              </label>
            </div>
            <div class="grow">
              <label for="res-filter-search">Search</label>
              <input id="res-filter-search" type="text" placeholder="Search track / car / series..." />
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Track</th>
                  <th>Car</th>
                  <th>Series</th>
                  <th>Start</th>
                  <th>Finish</th>
                  <th>Best Lap</th>
                  <th>iR Œî</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="res-tbody"></tbody>
            </table>
            <div class="empty-state" id="res-empty">
              <strong>No race results yet.</strong><br />
              Add some race sessions on the Sessions tab.
            </div>
            <div class="table-footer">
              <span id="res-footer-label">0 races visible</span>
              <span id="res-footer-extra">0 wins ‚Ä¢ 0 podiums</span>
            </div>
          </div>
        </section>
      </main>
    </section>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "iracing_personal_records_v1";

      let races = [];
      let currentSort = { field: "date", direction: "desc" };

      // Form + session view elements
      const form = document.getElementById("race-form");
      const raceIdInput = document.getElementById("race-id");
      const dateInput = document.getElementById("date");
      const sessionTypeInput = document.getElementById("sessionType");
      const seriesInput = document.getElementById("series");
      const carInput = document.getElementById("car");
      const trackInput = document.getElementById("track");
      const splitInput = document.getElementById("split");
      const sofInput = document.getElementById("sof");
      const startPosInput = document.getElementById("startPos");
      const finishPosInput = document.getElementById("finishPos");
      const lapsInput = document.getElementById("laps");
      const bestLapInput = document.getElementById("bestLap");
      const iratingChangeInput = document.getElementById("iratingChange");
      const notesInput = document.getElementById("notes");

      const saveBtnLabel = document.getElementById("save-btn-label");
      const resetFormBtn = document.getElementById("reset-form-btn");
      const clearAllBtn = document.getElementById("clear-all-btn");

      const exportTextarea = document.getElementById("export-json");
      const exportBtn = document.getElementById("export-btn");
      const importBtn = document.getElementById("import-btn");

      const tbody = document.getElementById("race-tbody");
      const emptyState = document.getElementById("empty-state");
      const sessionCountSpan = document.getElementById("session-count");
      const tableFooterLabel = document.getElementById("table-footer-label");

      const filterSearch = document.getElementById("filter-search");
      const filterSession = document.getElementById("filter-session");
      const filterSortPreset = document.getElementById("filter-sort-preset");

      // Stats
      const statTotalRaces = document.getElementById("stat-total-races");
      const statTotalSessions = document.getElementById("stat-total-sessions");
      const statWins = document.getElementById("stat-wins");
      const statPodiums = document.getElementById("stat-podiums");
      const statBestLap = document.getElementById("stat-best-lap");
      const statBestLapTrack = document.getElementById("stat-best-lap-track");

      // Lap view
      const lapTbody = document.getElementById("lap-tbody");
      const lapEmpty = document.getElementById("lap-empty");
      const lapFooterLabel = document.getElementById("lap-footer-label");
      const lapFilterTrack = document.getElementById("lap-filter-track");
      const lapFilterCar = document.getElementById("lap-filter-car");
      const lapFilterSearch = document.getElementById("lap-filter-search");

      // Results view
      const resTbody = document.getElementById("res-tbody");
      const resEmpty = document.getElementById("res-empty");
      const resFooterLabel = document.getElementById("res-footer-label");
      const resFooterExtra = document.getElementById("res-footer-extra");
      const resFilterOnlyWins = document.getElementById("res-filter-only-wins");
      const resFilterOnlyPodiums = document.getElementById("res-filter-only-podiums");
      const resFilterSearch = document.getElementById("res-filter-search");

      // NAV
      const navTabs = document.querySelectorAll(".nav-tab");
      const views = {
        sessions: document.getElementById("view-sessions"),
        laps: document.getElementById("view-laps"),
        results: document.getElementById("view-results")
      };

      function setView(viewId) {
        Object.keys(views).forEach(id => {
          views[id].classList.toggle("view-active", id === viewId);
        });
        navTabs.forEach(btn =>
          btn.classList.toggle(
            "nav-tab-active",
            btn.getAttribute("data-view") === viewId
          )
        );
      }

      navTabs.forEach(btn => {
        btn.addEventListener("click", () => {
          const v = btn.getAttribute("data-view");
          setView(v);
        });
      });

      function loadFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            races = [];
            return;
          }
          const parsed = JSON.parse(raw);
          races = Array.isArray(parsed) ? parsed : [];
        } catch {
          races = [];
        }
      }

      function saveToStorage() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(races));
        } catch {}
      }

      function parseNumber(value) {
        if (value === "" || value === null || typeof value === "undefined") return null;
        const n = Number(value);
        return isNaN(n) ? null : n;
      }

      function parseLapTimeToSeconds(str) {
        if (!str) return null;
        const s = String(str).trim();
        if (!s) return null;
        if (s.includes(":")) {
          const parts = s.split(":");
          if (parts.length !== 2) return null;
          const m = Number(parts[0]);
          const sec = Number(parts[1]);
          if (isNaN(m) || isNaN(sec)) return null;
          return m * 60 + sec;
        } else {
          const sec = Number(s);
          if (isNaN(sec)) return null;
          return sec;
        }
      }

      function formatDateDisplay(value) {
        if (!value) return "";
        try {
          const [y, m, d] = value.split("-");
          return `${m}/${d}/${y}`;
        } catch {
          return value;
        }
      }

      function formatLapTime(str) {
        if (!str) return "";
        const sec = parseLapTimeToSeconds(str);
        if (sec === null) return str;
        const minutes = Math.floor(sec / 60);
        const seconds = sec % 60;
        if (minutes > 0) {
          return `${minutes}:${seconds.toFixed(3).padStart(6, "0")}`;
        }
        return seconds.toFixed(3);
      }

      function clearForm() {
        form.reset();
        raceIdInput.value = "";
        saveBtnLabel.textContent = "Add Session";
        const today = new Date();
        const iso = today.toISOString().slice(0, 10);
        dateInput.value = iso;
      }

      function handleFormSubmit(event) {
        event.preventDefault();

        const id = raceIdInput.value || String(Date.now());
        const race = {
          id,
          date: dateInput.value || null,
          sessionType: sessionTypeInput.value || "Race",
          series: seriesInput.value.trim(),
          car: carInput.value.trim(),
          track: trackInput.value.trim(),
          split: parseNumber(splitInput.value),
          sof: parseNumber(sofInput.value),
          startPos: parseNumber(startPosInput.value),
          finishPos: parseNumber(finishPosInput.value),
          laps: parseNumber(lapsInput.value),
          bestLap: bestLapInput.value.trim() || "",
          iratingChange: parseNumber(iratingChangeInput.value),
          notes: notesInput.value.trim(),
          createdAt: Date.now()
        };

        const existingIndex = races.findIndex(r => r.id === id);
        if (existingIndex >= 0) {
          races[existingIndex] = race;
        } else {
          races.push(race);
        }

        saveToStorage();
        refreshAllViews();
        clearForm();
      }

      function handleEdit(id) {
        const race = races.find(r => r.id === id);
        if (!race) return;

        raceIdInput.value = race.id;
        dateInput.value = race.date || "";
        sessionTypeInput.value = race.sessionType || "Race";
        seriesInput.value = race.series || "";
        carInput.value = race.car || "";
        trackInput.value = race.track || "";
        splitInput.value = race.split ?? "";
        sofInput.value = race.sof ?? "";
        startPosInput.value = race.startPos ?? "";
        finishPosInput.value = race.finishPos ?? "";
        lapsInput.value = race.laps ?? "";
        bestLapInput.value = race.bestLap || "";
        iratingChangeInput.value = race.iratingChange ?? "";
        notesInput.value = race.notes || "";
        saveBtnLabel.textContent = "Update Session";
        window.scrollTo({ top: 0, behavior: "smooth" });
        setView("sessions");
      }

      function handleDelete(id) {
        if (!confirm("Delete this session? This cannot be undone.")) return;
        races = races.filter(r => r.id !== id);
        saveToStorage();
        refreshAllViews();
      }

      function handleClearAll() {
        if (!confirm("Clear ALL saved sessions? This cannot be undone.")) return;
        races = [];
        saveToStorage();
        refreshAllViews();
        clearForm();
      }

      function handleExport() {
        exportTextarea.value = JSON.stringify(races, null, 2);
        exportTextarea.select();
        try {
          document.execCommand("copy");
        } catch {}
      }

      function handleImport() {
        let raw = exportTextarea.value.trim();
        if (!raw) {
          alert("Paste JSON data into the box first.");
          return;
        }
        try {
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) {
            alert("Invalid JSON: expected an array.");
            return;
          }
          if (!confirm("Importing will replace your current data. Continue?")) {
            return;
          }
          races = parsed;
          saveToStorage();
          refreshAllViews();
          alert("Import complete.");
        } catch (e) {
          alert("Failed to parse JSON. Check your data and try again.");
        }
      }

      function applyFiltersSession(list) {
        const q = filterSearch.value.trim().toLowerCase();
        const sessionFilter = filterSession.value;

        return list.filter(r => {
          if (sessionFilter && r.sessionType !== sessionFilter) return false;

          if (q) {
            const blob = [r.series, r.car, r.track, r.notes, r.sessionType]
              .filter(Boolean)
              .join(" ")
              .toLowerCase();
            if (!blob.includes(q)) return false;
          }

          return true;
        });
      }

      function applySort(list) {
        const arr = [...list];
        const { field, direction } = currentSort;
        const asc = direction === "asc" ? 1 : -1;

        arr.sort((a, b) => {
          let av = a[field];
          let bv = b[field];

          if (field === "date") {
            const aTime = av ? new Date(av).getTime() : 0;
            const bTime = bv ? new Date(bv).getTime() : 0;
            return (aTime - bTime) * asc;
          }

          if (field === "bestLap") {
            const aLap = parseLapTimeToSeconds(av);
            const bLap = parseLapTimeToSeconds(bv);
            if (aLap === null && bLap === null) return 0;
            if (aLap === null) return 1;
            if (bLap === null) return -1;
            return (aLap - bLap) * asc;
          }

          if (typeof av === "number" && typeof bv === "number") {
            if (av === bv) return 0;
            return av > bv ? asc : -asc;
          }

          av = (av ?? "").toString().toLowerCase();
          bv = (bv ?? "").toString().toLowerCase();
          if (av === bv) return 0;
          return av > bv ? asc : -asc;
        });

        return arr;
      }

      function updateStats() {
        const totalSessions = races.length;
        const raceSessions = races.filter(r => r.sessionType === "Race");
        const totalRaces = raceSessions.length;
        const wins = raceSessions.filter(r => r.finishPos === 1).length;
        const podiums = raceSessions.filter(
          r => typeof r.finishPos === "number" && r.finishPos > 0 && r.finishPos <= 3
        ).length;

        statTotalSessions.textContent = `${totalSessions} session${totalSessions === 1 ? "" : "s"}`;
        statTotalRaces.textContent = totalRaces;
        statWins.textContent = wins;
        statPodiums.textContent = `${podiums} podium${podiums === 1 ? "" : "s"}`;

        let best = null;
        let bestRace = null;
        for (const r of races) {
          const sec = parseLapTimeToSeconds(r.bestLap);
          if (sec === null) continue;
          if (best === null || sec < best) {
            best = sec;
            bestRace = r;
          }
        }

        if (best === null || !bestRace) {
          statBestLap.textContent = "‚Äì";
          statBestLapTrack.textContent = "No laps logged yet";
        } else {
          statBestLap.textContent = formatLapTime(bestRace.bestLap);
          statBestLapTrack.textContent = `${bestRace.track || "Unknown"} (${bestRace.car || "car?"})`;
        }
      }

      function refreshSessionView() {
        sessionCountSpan.textContent = races.length;

        const filtered = applyFiltersSession(races);
        const sorted = applySort(filtered);

        tbody.innerHTML = "";
        emptyState.style.display = sorted.length === 0 ? "block" : "none";

        for (const r of sorted) {
          const tr = document.createElement("tr");

          const dateTd = document.createElement("td");
          dateTd.textContent = formatDateDisplay(r.date);
          tr.appendChild(dateTd);

          const typeTd = document.createElement("td");
          const typeTag = document.createElement("span");
          typeTag.className = "tag";
          typeTag.textContent = r.sessionType || "‚Äì";
          typeTd.appendChild(typeTag);
          tr.appendChild(typeTd);

          const seriesTd = document.createElement("td");
          seriesTd.textContent = r.series || "‚Äì";
          tr.appendChild(seriesTd);

          const carTd = document.createElement("td");
          carTd.textContent = r.car || "‚Äì";
          tr.appendChild(carTd);

          const trackTd = document.createElement("td");
          trackTd.textContent = r.track || "‚Äì";
          tr.appendChild(trackTd);

          const splitTd = document.createElement("td");
          splitTd.textContent = r.split != null ? r.split : "‚Äì";
          tr.appendChild(splitTd);

          const sofTd = document.createElement("td");
          sofTd.textContent = r.sof != null ? r.sof : "‚Äì";
          tr.appendChild(sofTd);

          const startTd = document.createElement("td");
          startTd.textContent = r.startPos != null ? r.startPos : "‚Äì";
          tr.appendChild(startTd);

          const finishTd = document.createElement("td");
          finishTd.textContent = r.finishPos != null ? r.finishPos : "‚Äì";
          tr.appendChild(finishTd);

          const bestLapTd = document.createElement("td");
          bestLapTd.textContent = r.bestLap ? formatLapTime(r.bestLap) : "‚Äì";
          tr.appendChild(bestLapTd);

          const irTd = document.createElement("td");
          if (typeof r.iratingChange === "number") {
            const value = r.iratingChange;
            irTd.textContent = value > 0 ? `+${value}` : `${value}`;
            irTd.style.color = value > 0 ? "var(--success)" : value < 0 ? "var(--danger)" : "inherit";
          } else {
            irTd.textContent = "‚Äì";
          }
          tr.appendChild(irTd);

          const notesTd = document.createElement("td");
          notesTd.className = "cell-notes";
          notesTd.textContent = r.notes || "";
          tr.appendChild(notesTd);

          const actionsTd = document.createElement("td");
          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "secondary";
          editBtn.textContent = "Edit";
          editBtn.style.fontSize = "11px";
          editBtn.addEventListener("click", () => handleEdit(r.id));

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "secondary";
          deleteBtn.textContent = "Del";
          deleteBtn.style.fontSize = "11px";
          deleteBtn.style.borderColor = "rgba(255,76,76,0.4)";
          deleteBtn.style.color = "#ff8a8a";
          deleteBtn.addEventListener("click", () => handleDelete(r.id));

          actionsTd.appendChild(editBtn);
          actionsTd.appendChild(deleteBtn);
          tr.appendChild(actionsTd);

          tbody.appendChild(tr);
        }

        tableFooterLabel.textContent = `${sorted.length} session${sorted.length === 1 ? "" : "s"} visible`;
        updateStats();
        updateSortHeaderIndicators();
      }

      function updateSortHeaderIndicators() {
        const ths = document.querySelectorAll("thead th.sortable");
        ths.forEach(th => {
          th.classList.remove("sort-asc", "sort-desc");
          const field = th.getAttribute("data-sort");
          if (field === currentSort.field) {
            th.classList.add(currentSort.direction === "asc" ? "sort-asc" : "sort-desc");
          }
        });
      }

      function handleHeaderClick(event) {
        const th = event.target.closest("th.sortable");
        if (!th) return;
        const field = th.getAttribute("data-sort");
        if (!field) return;
        if (currentSort.field === field) {
          currentSort.direction = currentSort.direction === "asc" ? "desc" : "asc";
        } else {
          currentSort.field = field;
          currentSort.direction = field === "date" ? "desc" : "asc";
        }
        refreshSessionView();
        syncSortPresetWithCurrent();
      }

      function syncSortPresetWithCurrent() {
        const { field, direction } = currentSort;
        let value = "date-desc";
        if (field === "date" && direction === "desc") value = "date-desc";
        else if (field === "date" && direction === "asc") value = "date-asc";
        else if (field === "bestLap" && direction === "asc") value = "bestLap-asc";
        else if (field === "finishPos" && direction === "asc") value = "finishPos-asc";
        else if (field === "iratingChange" && direction === "desc") value = "iratingChange-desc";
        filterSortPreset.value = value;
      }

      function handleSortPresetChange() {
        const value = filterSortPreset.value;
        switch (value) {
          case "date-desc":
            currentSort = { field: "date", direction: "desc" };
            break;
          case "date-asc":
            currentSort = { field: "date", direction: "asc" };
            break;
          case "bestLap-asc":
            currentSort = { field: "bestLap", direction: "asc" };
            break;
          case "finishPos-asc":
            currentSort = { field: "finishPos", direction: "asc" };
            break;
          case "iratingChange-desc":
            currentSort = { field: "iratingChange", direction: "desc" };
            break;
        }
        refreshSessionView();
      }

      function initDefaultDate() {
        if (!dateInput.value) {
          const today = new Date();
          const iso = today.toISOString().slice(0, 10);
          dateInput.value = iso;
        }
      }

      // Lap view helpers
      function buildLapFilterOptions() {
        const tracks = new Set();
        const cars = new Set();
        races.forEach(r => {
          if (r.bestLap && r.track) tracks.add(r.track);
          if (r.bestLap && r.car) cars.add(r.car);
        });

        const currentTrack = lapFilterTrack.value;
        const currentCar = lapFilterCar.value;

        lapFilterTrack.innerHTML = `<option value="">All tracks</option>`;
        Array.from(tracks).sort().forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          lapFilterTrack.appendChild(opt);
        });
        if (currentTrack) lapFilterTrack.value = currentTrack;

        lapFilterCar.innerHTML = `<option value="">All cars</option>`;
        Array.from(cars).sort().forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          lapFilterCar.appendChild(opt);
        });
        if (currentCar) lapFilterCar.value = currentCar;
      }

      function refreshLapView() {
        buildLapFilterOptions();

        const trackVal = lapFilterTrack.value;
        const carVal = lapFilterCar.value;
        const q = lapFilterSearch.value.trim().toLowerCase();

        const laps = races.filter(r => r.bestLap && r.bestLap.trim() !== "");

        const filtered = laps.filter(r => {
          if (trackVal && r.track !== trackVal) return false;
          if (carVal && r.car !== carVal) return false;
          if (q) {
            const blob = [r.series, r.notes].filter(Boolean).join(" ").toLowerCase();
            if (!blob.includes(q)) return false;
          }
          return true;
        });

        lapTbody.innerHTML = "";
        lapEmpty.style.display = filtered.length === 0 ? "block" : "none";

        const sorted = [...filtered].sort((a, b) => {
          const aLap = parseLapTimeToSeconds(a.bestLap);
          const bLap = parseLapTimeToSeconds(b.bestLap);
          if (aLap === null && bLap === null) return 0;
          if (aLap === null) return 1;
          if (bLap === null) return -1;
          return aLap - bLap;
        });

        for (const r of sorted) {
          const tr = document.createElement("tr");

          const dateTd = document.createElement("td");
          dateTd.textContent = formatDateDisplay(r.date);
          tr.appendChild(dateTd);

          const trackTd = document.createElement("td");
          trackTd.textContent = r.track || "‚Äì";
          tr.appendChild(trackTd);

          const carTd = document.createElement("td");
          carTd.textContent = r.car || "‚Äì";
          tr.appendChild(carTd);

          const typeTd = document.createElement("td");
          typeTd.textContent = r.sessionType || "‚Äì";
          tr.appendChild(typeTd);

          const lapTd = document.createElement("td");
          lapTd.textContent = formatLapTime(r.bestLap);
          tr.appendChild(lapTd);

          const seriesTd = document.createElement("td");
          seriesTd.textContent = r.series || "‚Äì";
          tr.appendChild(seriesTd);

          const notesTd = document.createElement("td");
          notesTd.className = "cell-notes";
          notesTd.textContent = r.notes || "";
          tr.appendChild(notesTd);

          lapTbody.appendChild(tr);
        }

        lapFooterLabel.textContent = `${filtered.length} lap${filtered.length === 1 ? "" : "s"} visible`;
      }

      // Results view
      function refreshResultsView() {
        const q = resFilterSearch.value.trim().toLowerCase();
        const onlyWins = resFilterOnlyWins.checked;
        const onlyPodiums = resFilterOnlyPodiums.checked;

        const racesOnly = races.filter(r => r.sessionType === "Race");

        const filtered = racesOnly.filter(r => {
          if (onlyWins && r.finishPos !== 1) return false;
          if (onlyPodiums && !(typeof r.finishPos === "number" && r.finishPos > 0 && r.finishPos <= 3)) {
            return false;
          }
          if (q) {
            const blob = [r.track, r.car, r.series, r.notes]
              .filter(Boolean)
              .join(" ")
              .toLowerCase();
            if (!blob.includes(q)) return false;
          }
          return true;
        });

        const sorted = [...filtered].sort((a, b) => {
          const aDate = a.date ? new Date(a.date).getTime() : 0;
          const bDate = b.date ? new Date(b.date).getTime() : 0;
          return bDate - aDate;
        });

        resTbody.innerHTML = "";
        resEmpty.style.display = sorted.length === 0 ? "block" : "none";

        let wins = 0;
        let podiums = 0;

        for (const r of sorted) {
          if (r.finishPos === 1) wins++;
          if (typeof r.finishPos === "number" && r.finishPos > 0 && r.finishPos <= 3) podiums++;

          const tr = document.createElement("tr");

          const dateTd = document.createElement("td");
          dateTd.textContent = formatDateDisplay(r.date);
          tr.appendChild(dateTd);

          const trackTd = document.createElement("td");
          trackTd.textContent = r.track || "‚Äì";
          tr.appendChild(trackTd);

          const carTd = document.createElement("td");
          carTd.textContent = r.car || "‚Äì";
          tr.appendChild(carTd);

          const seriesTd = document.createElement("td");
          seriesTd.textContent = r.series || "‚Äì";
          tr.appendChild(seriesTd);

          const startTd = document.createElement("td");
          startTd.textContent = r.startPos != null ? r.startPos : "‚Äì";
          tr.appendChild(startTd);

          const finishTd = document.createElement("td");
          finishTd.textContent = r.finishPos != null ? r.finishPos : "‚Äì";
          tr.appendChild(finishTd);

          const lapTd = document.createElement("td");
          lapTd.textContent = r.bestLap ? formatLapTime(r.bestLap) : "‚Äì";
          tr.appendChild(lapTd);

          const irTd = document.createElement("td");
          if (typeof r.iratingChange === "number") {
            const value = r.iratingChange;
            irTd.textContent = value > 0 ? `+${value}` : `${value}`;
            irTd.style.color = value > 0 ? "var(--success)" : value < 0 ? "var(--danger)" : "inherit";
          } else {
            irTd.textContent = "‚Äì";
          }
          tr.appendChild(irTd);

          const notesTd = document.createElement("td");
          notesTd.className = "cell-notes";
          notesTd.textContent = r.notes || "";
          tr.appendChild(notesTd);

          resTbody.appendChild(tr);
        }

        resFooterLabel.textContent = `${sorted.length} race${sorted.length === 1 ? "" : "s"} visible`;
        resFooterExtra.textContent = `${wins} win${wins === 1 ? "" : "s"} ‚Ä¢ ${podiums} podium${podiums === 1 ? "" : "s"}`;
      }

      function refreshAllViews() {
        refreshSessionView();
        refreshLapView();
        refreshResultsView();
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadFromStorage();
        initDefaultDate();
        refreshAllViews();

        form.addEventListener("submit", handleFormSubmit);
        resetFormBtn.addEventListener("click", clearForm);
        clearAllBtn.addEventListener("click", handleClearAll);
        exportBtn.addEventListener("click", handleExport);
        importBtn.addEventListener("click", handleImport);

        filterSearch.addEventListener("input", refreshAllViews);
        filterSession.addEventListener("change", refreshAllViews);
        filterSortPreset.addEventListener("change", handleSortPresetChange);

        lapFilterTrack.addEventListener("change", refreshLapView);
        lapFilterCar.addEventListener("change", refreshLapView);
        lapFilterSearch.addEventListener("input", refreshLapView);

        resFilterOnlyWins.addEventListener("change", refreshResultsView);
        resFilterOnlyPodiums.addEventListener("change", refreshResultsView);
        resFilterSearch.addEventListener("input", refreshResultsView);

        const head = document.querySelector("#view-sessions thead");
        if (head) head.addEventListener("click", handleHeaderClick);
      });
    })();
  </script>
</body>
</html>
